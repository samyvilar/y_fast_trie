
#include <stdio.h>
#include <string.h>

#include "mt_rand.h"
#include "bits.h"
#include "mem.h"
#include "vector.h"

#include "timed.h"

#define vect_align_attr(v) __attribute__ ((aligned (sizeof(v))))

#define RAND_GEN_STATE_LENGTH 624U
#define mt_state_word_cnt(type) (RAND_GEN_STATE_LENGTH / (bit_size(type) / 32)) // calc number words for the state table ...

#define mt_states(mt)               ((mt)->_states)
#define mt_state_entry(mt, index)   (mt_states(mt)[index])
#define mt_state_t(mt)              typeof(mt_state_entry(mt, 0))

#define mt_states_cnt(mt)   mt_state_word_cnt(mt_state_t(mt))

#define mt_index(mt)        ((mt)->_index)
#define mt_set_index(mt, v) (mt_index(mt) = (v))

#define mt_state_set_entry(mt, index, value) (mt_state_entry(mt, index) = (value))



#define mt_typedef_templ(_bit_size)                                             \
    typedef struct mt_state_ ## _bit_size ## _t {                               \
        uint_bit_t(_bit_size)                                                   \
        vect_align_attr(vector_t)                                               \
            _states[                                                            \
                mt_state_word_cnt(uint_bit_t(_bit_size))                        \
                    + (vector_cnt(uint_bit_t(32)) + 1)                          \
                    /* add extra buffer for vector operations ...*/             \
            ], _index;                                                          \
    } mt_state_ ## _bit_size ## _t

mt_typedef_templ(32);
mt_typedef_templ(64);
//typedef struct mt_state_32_t { // 32 bit mersenne twister ...
//    uint_bit_t(32)
//    vect_align_attr(vector_t)
//        _states[mt_states_cnt((struct mt_state_32_t *){})  + (vector_cnt(uint_bit_t(32)) + 1)], // add extra buffer when applying vector operations ...
//        _index;
//} mt_state_32_t;
//
//typedef struct mt_state_64_t {
//    uint_bit_t(64)
//    vect_align_attr(vector_t)
//        _states[mt_states_cnt((struct mt_state_64_t *){}) + (vector_cnt(uint_bit_t(64)) + 1)],
//        _index;
//} mt_state_64_t;

#define mt_coeff_32 2567483615U
#define mt_coeff_64 0xB5026F5AA96619E9ULL
#define mt_coeff(_bit_mag) mt_coeff_ ## _bit_mag

#define mt_seed_coef_32 1812433253U
#define mt_seed_coef_64 6364136223846793005ULL
#define mt_seed_coef(_bit_mag) mt_seed_coef_ ## _bit_mag

#define mt_mid_word_32 397
#define mt_mid_word_64 156

#define mt_mid_word(_bit_mag) mt_mid_word_ ## _bit_mag


mt_state_32_t *mt_32 = &(mt_state_32_t){
    ._states = {  // MERSENNE TWISTER initial state ...
        1212423U, 1644249540U, 1058299835U, 1281480650U, 161662491U, 3086588844U, 3549202860U, 1139407122U, 3575607175U, 2763039517U, 181727813U, 4153246276U, 3917309199U, 216025545U, 3967331675U, 3184032711U, 2830647753U, 2624886824U, 9732772U, 1996312263U, 813828658U, 438355919U, 2760219585U, 4016492294U, 1031559697U, 1891213774U, 2440928709U, 3832528542U, 1600338189U, 1526787545U, 126774870U, 2157415949U, 221909771U, 1969710712U, 2163289823U, 1967571540U, 1329408173U, 2862159873U, 676664405U, 3687154352U, 2126732231U, 2577017671U, 1709047651U, 1374630869U, 820504272U, 1974689853U, 1609110490U, 2173831318U, 4047541908U, 2436053188U, 3355532368U,
        758568946U, 802272430U, 1882154715U, 1756642872U, 2214071732U, 4163751686U, 855595570U, 1432442868U, 2334970084U, 2730721530U, 4260272661U, 1580372204U, 738001600U, 3565868544U, 1164118640U, 1438685143U, 1427598769U, 1539405492U, 1456321198U, 177219153U, 2274850620U, 4165220798U, 3321621722U, 4094923495U, 4187027519U, 615386104U, 2430234917U, 2563605425U, 1651818734U, 1842939291U, 2580848659U, 117653511U, 901579286U, 2957613314U, 518675797U, 129781727U, 388160082U, 1473512626U, 3255739896U, 3564621665U, 4109255685U, 2291272890U, 58031349U, 65825287U, 3946091554U, 3890944613U, 296485023U, 495605277U, 1182039764U, 2007566189U,
        1855764993U, 2573165158U, 1862620635U, 4177693034U, 2808637398U, 848128782U, 1970780913U, 3352768796U, 1829304488U, 3929771035U, 1008672231U, 2761452435U, 2661943718U, 196776486U, 2145124209U, 1770960804U, 2803417486U, 2267826354U, 1143922151U, 344433206U, 3872122311U, 616794830U, 3658482113U, 2106557446U, 3883390528U, 2479252461U, 139023562U, 215256626U, 3411205179U, 890428058U, 4188186949U, 2997698338U, 1862404133U, 1260681914U, 1781497678U, 520585651U, 1380185896U, 3795088567U, 1913806735U, 1531228562U, 2754001548U, 2130679956U, 3952210008U, 11634551U, 801776004U, 2706038182U, 4070716999U, 3034959208U, 2944255335U, 2365910639U,
        3347408536U, 1304915647U, 2569297807U, 4216793147U, 2272319155U, 1564503409U, 2198609357U, 1415875145U, 1101207303U, 1439976446U, 560362300U, 2008716110U, 1889166798U, 705622607U, 2344280272U, 3771274624U, 644716630U, 1109205142U, 1141877564U, 2810000571U, 2460733096U, 772244414U, 4037650595U, 3666683854U, 1452829072U, 3382132709U, 1093160047U, 3301901848U, 4272872538U, 2706870481U, 2110918388U, 3532915807U, 960427267U, 1040860647U, 1455895516U, 2120465387U, 407854605U, 520098013U, 4128763118U, 1538674495U, 302477877U, 2491509929U, 4142162744U, 1003665929U, 1106327376U, 3388746937U, 1434660903U, 1250973124U, 490423424U, 529172296U,
        2802116657U, 1654122473U, 1751230291U, 2622481958U, 3903525121U, 2795882648U, 3958935441U, 2732836714U, 2104251609U, 3876393482U, 1896738656U, 2269207321U, 944203132U, 2145281730U, 2333206214U, 1911222316U, 963893146U, 2253093532U, 1656221489U, 736235212U, 3249472345U, 575503712U, 3997882303U, 1193196044U, 319511810U, 4216308908U, 193151214U, 4144626890U, 2226605362U, 3505398998U, 3494348272U, 2693522631U, 2449584034U, 3473337098U, 2596375672U, 4057970446U, 2744397326U, 678336426U, 7459073U, 952631125U, 1172257402U, 2226841209U, 2490483322U, 1664873036U, 1466748502U, 280688713U, 1050805956U, 1256689740U, 3887080538U, 912324887U,
        3710948878U, 3671271709U, 505563091U, 918241853U, 1509869584U, 2131560629U, 1186513925U, 3555162774U, 2969574092U, 2265240138U, 4184309613U, 2903057772U, 2544214893U, 3302548179U, 2929904921U, 96165809U, 3539565280U, 3748001691U, 2581792773U, 1645144785U, 3611030815U, 2224533788U, 4252233703U, 3378162182U, 3085222412U, 796659354U, 2113416663U, 206281860U, 1211327787U, 2039506090U, 545536912U, 4177236202U, 506191368U, 3545817668U, 387597856U, 2546256830U, 332398155U, 3090315191U, 1340872842U, 823464697U, 893828704U, 2506784004U, 3809839747U, 3894289830U, 1502423104U, 1694673869U, 177337509U, 2483344195U, 767304400U, 1837829436U,
        3130842942U, 4261359578U, 2704802508U, 2419808886U, 335463669U, 4187869915U, 3573663851U, 1489746492U, 3803586630U, 3875711343U, 3266028755U, 3936048968U, 3087897808U, 2344491540U, 3700429289U, 1406356622U, 2453585064U, 643656272U, 3371156175U, 4184541116U, 2023245468U, 1009312307U, 1351846498U, 1274647891U, 933153951U, 2575356673U, 2312428662U, 1109462796U, 2910053994U, 2715783250U, 866042075U, 4241771187U, 2794039485U, 2429995945U, 3446267590U, 3865006601U, 1556658499U, 4012075612U, 1233047502U, 3739665663U, 593138881U, 3919510139U, 3104508591U, 818728089U, 4269382326U, 280487875U, 2649410634U, 3941409220U, 1997722592U, 3304587811U,
        4259051519U, 4150440908U, 2866002188U, 2868019688U, 2123988149U, 1865844840U, 375587794U, 2228872512U, 578143857U, 3099641085U, 74658052U, 1841921022U, 466772998U, 3585256906U, 2063475386U, 1576454197U, 2364330483U, 3210727045U, 1610857396U, 1591733467U, 3054443893U, 3975958631U, 3914153193U, 3279438792U, 4182205326U, 3259743513U, 1405781691U, 2551624412U, 2998886673U, 2616817915U, 1710816442U, 1201195589U, 996291155U, 1592870719U, 2936228599U, 941404459U, 2051992186U, 3388692235U, 4076117933U, 2310610732U, 2851794093U, 2775714195U, 3155386558U, 2274215862U, 3233488783U, 445210568U, 4209824629U, 1288934684U, 3658570496U, 329417919U,
        3982596076U, 3713587677U, 2109195305U, 781307228U, 3555738337U, 1573082816U, 1388676284U, 3105981737U, 3265957520U, 4254854297U, 4032349277U, 1521338546U, 3353148220U, 2405226617U, 249052454U, 1209235358U, 873155164U, 1807979502U, 232605166U, 876279434U, 519643159U, 521599417U, 1875085476U, 348665793U, 1260079566U, 2498553685U, 2426787326U, 4208282136U, 2240524628U, 2472410780U, 262800389U, 1650279593U, 2032271353U, 2620241546U, 1919929691U, 2423730230U, 155048505U, 3267271475U, 1418718119U, 3681407030U, 1681032098U, 3990170633U, 1441905581U, 4152498328U, 1438362084U, 2184746519U, 2671211784U, 3922299058U, 2139138198U, 2015122517U,
        1251621607U, 2628277378U, 857856069U, 1325023743U, 201259261U, 3116540569U, 1225530352U, 3159490783U, 1893441020U, 471645085U, 3574074302U, 1755301983U, 3956694245U, 1435745934U, 1580054332U, 1573122531U, 3488506365U, 1903139082U, 1295730220U, 405522071U, 414001770U, 1223325610U, 2822290256U, 1910426420U, 303598276U, 3243091248U, 3647961596U, 1530763897U, 3493866295U, 2665210212U, 2317976863U, 2590575443U, 2646004184U, 3294918374U, 461797182U, 1016019804U, 4207585587U, 1188000216U, 2629045638U, 1021377278U, 1879504417U, 659963020U, 1665192233U, 1889070774U, 4279705378U, 3383685877U, 2663744255U, 2817594563U, 1132428056U, 3285906385U,
        3030095311U, 422039767U, 2774103498U, 3033235936U, 570044963U, 1870628041U, 1020685539U, 2131980939U, 3837660271U, 3667178650U, 1300243292U, 1510324913U, 4026194289U, 4134784508U, 1793506974U, 4083502527U, 2914339121U, 286731813U, 81396640U, 794038312U, 4192717265U, 3224503268U, 656616238U, 3644696882U, 20314978U, 2508300728U, 1070029425U, 4263782821U, 3390588559U, 3072901966U, 2058140431U, 3684846746U, 641014642U, 1455544336U, 194140620U, 1734318996U, 269361378U, 593096004U, 1062207983U, 2904730727U, 800264950U, 4085654316U, 2802387626U, 3890028136U, 3362866520U, 4232778249U, 1821080085U, 1038606344U, 60271949U, 3484456583U,
        1054083131U, 1605096559U, 3933974415U, 2425499750U, 3360595359U, 950054072U, 2900008645U, 2091525553U, 2233208991U, 960599329U, 2945810742U, 3230453686U, 1554567580U, 3725769253U, 3255552307U, 2644578854U, 306015851U, 994104687U, 3168116228U, 2885849240U, 681277693U, 1140925197U, 1971864057U, 3084370198U, 3053380387U, 1459832645U, 3091891221U, 3870781013U, 2093256753U, 2617677108U, 4042049171U, 4053625110U, 1273607312U, 550295677U, 941052058U, 3347790092U, 517966902U, 1840593306U, 999337844U, 2854637330U, 2329723807U, 2199073857U, 2942335936U, 228173788U, 4286052383U, 2531254624U, 3617546239U, 1277344962U, 235787846U, 1460339190U,
        2099640268U, 4096949051U, 1516476275U, 829736022U, 2793242187U, 404153899U, 828560470U, 1979305550U, 857714316U, 4122790814U, 3384695892U, 2984640439U, 2676539854U, 2101257186U, 782247414U, 3946422902U, 1927329682U, 2649430633U, 4224823714U, 1496399857U, 2335550493U, 1847755177U, 1452806583U,

        1212423U, 1644249540U, 1058299835U, 1281480650U // add extra elements to act as buffer properly loaded when applying vectorize instructions...
    },
    ._index = 0
};

mt_state_32_t *mt_32_non_sse = &(mt_state_32_t){
    ._states = {  // MERSENNE TWISTER initial state ...
        1212423U, 1644249540U, 1058299835U, 1281480650U, 161662491U, 3086588844U, 3549202860U, 1139407122U, 3575607175U, 2763039517U, 181727813U, 4153246276U, 3917309199U, 216025545U, 3967331675U, 3184032711U, 2830647753U, 2624886824U, 9732772U, 1996312263U, 813828658U, 438355919U, 2760219585U, 4016492294U, 1031559697U, 1891213774U, 2440928709U, 3832528542U, 1600338189U, 1526787545U, 126774870U, 2157415949U, 221909771U, 1969710712U, 2163289823U, 1967571540U, 1329408173U, 2862159873U, 676664405U, 3687154352U, 2126732231U, 2577017671U, 1709047651U, 1374630869U, 820504272U, 1974689853U, 1609110490U, 2173831318U, 4047541908U, 2436053188U, 3355532368U,
        758568946U, 802272430U, 1882154715U, 1756642872U, 2214071732U, 4163751686U, 855595570U, 1432442868U, 2334970084U, 2730721530U, 4260272661U, 1580372204U, 738001600U, 3565868544U, 1164118640U, 1438685143U, 1427598769U, 1539405492U, 1456321198U, 177219153U, 2274850620U, 4165220798U, 3321621722U, 4094923495U, 4187027519U, 615386104U, 2430234917U, 2563605425U, 1651818734U, 1842939291U, 2580848659U, 117653511U, 901579286U, 2957613314U, 518675797U, 129781727U, 388160082U, 1473512626U, 3255739896U, 3564621665U, 4109255685U, 2291272890U, 58031349U, 65825287U, 3946091554U, 3890944613U, 296485023U, 495605277U, 1182039764U, 2007566189U,
        1855764993U, 2573165158U, 1862620635U, 4177693034U, 2808637398U, 848128782U, 1970780913U, 3352768796U, 1829304488U, 3929771035U, 1008672231U, 2761452435U, 2661943718U, 196776486U, 2145124209U, 1770960804U, 2803417486U, 2267826354U, 1143922151U, 344433206U, 3872122311U, 616794830U, 3658482113U, 2106557446U, 3883390528U, 2479252461U, 139023562U, 215256626U, 3411205179U, 890428058U, 4188186949U, 2997698338U, 1862404133U, 1260681914U, 1781497678U, 520585651U, 1380185896U, 3795088567U, 1913806735U, 1531228562U, 2754001548U, 2130679956U, 3952210008U, 11634551U, 801776004U, 2706038182U, 4070716999U, 3034959208U, 2944255335U, 2365910639U,
        3347408536U, 1304915647U, 2569297807U, 4216793147U, 2272319155U, 1564503409U, 2198609357U, 1415875145U, 1101207303U, 1439976446U, 560362300U, 2008716110U, 1889166798U, 705622607U, 2344280272U, 3771274624U, 644716630U, 1109205142U, 1141877564U, 2810000571U, 2460733096U, 772244414U, 4037650595U, 3666683854U, 1452829072U, 3382132709U, 1093160047U, 3301901848U, 4272872538U, 2706870481U, 2110918388U, 3532915807U, 960427267U, 1040860647U, 1455895516U, 2120465387U, 407854605U, 520098013U, 4128763118U, 1538674495U, 302477877U, 2491509929U, 4142162744U, 1003665929U, 1106327376U, 3388746937U, 1434660903U, 1250973124U, 490423424U, 529172296U,
        2802116657U, 1654122473U, 1751230291U, 2622481958U, 3903525121U, 2795882648U, 3958935441U, 2732836714U, 2104251609U, 3876393482U, 1896738656U, 2269207321U, 944203132U, 2145281730U, 2333206214U, 1911222316U, 963893146U, 2253093532U, 1656221489U, 736235212U, 3249472345U, 575503712U, 3997882303U, 1193196044U, 319511810U, 4216308908U, 193151214U, 4144626890U, 2226605362U, 3505398998U, 3494348272U, 2693522631U, 2449584034U, 3473337098U, 2596375672U, 4057970446U, 2744397326U, 678336426U, 7459073U, 952631125U, 1172257402U, 2226841209U, 2490483322U, 1664873036U, 1466748502U, 280688713U, 1050805956U, 1256689740U, 3887080538U, 912324887U,
        3710948878U, 3671271709U, 505563091U, 918241853U, 1509869584U, 2131560629U, 1186513925U, 3555162774U, 2969574092U, 2265240138U, 4184309613U, 2903057772U, 2544214893U, 3302548179U, 2929904921U, 96165809U, 3539565280U, 3748001691U, 2581792773U, 1645144785U, 3611030815U, 2224533788U, 4252233703U, 3378162182U, 3085222412U, 796659354U, 2113416663U, 206281860U, 1211327787U, 2039506090U, 545536912U, 4177236202U, 506191368U, 3545817668U, 387597856U, 2546256830U, 332398155U, 3090315191U, 1340872842U, 823464697U, 893828704U, 2506784004U, 3809839747U, 3894289830U, 1502423104U, 1694673869U, 177337509U, 2483344195U, 767304400U, 1837829436U,
        3130842942U, 4261359578U, 2704802508U, 2419808886U, 335463669U, 4187869915U, 3573663851U, 1489746492U, 3803586630U, 3875711343U, 3266028755U, 3936048968U, 3087897808U, 2344491540U, 3700429289U, 1406356622U, 2453585064U, 643656272U, 3371156175U, 4184541116U, 2023245468U, 1009312307U, 1351846498U, 1274647891U, 933153951U, 2575356673U, 2312428662U, 1109462796U, 2910053994U, 2715783250U, 866042075U, 4241771187U, 2794039485U, 2429995945U, 3446267590U, 3865006601U, 1556658499U, 4012075612U, 1233047502U, 3739665663U, 593138881U, 3919510139U, 3104508591U, 818728089U, 4269382326U, 280487875U, 2649410634U, 3941409220U, 1997722592U, 3304587811U,
        4259051519U, 4150440908U, 2866002188U, 2868019688U, 2123988149U, 1865844840U, 375587794U, 2228872512U, 578143857U, 3099641085U, 74658052U, 1841921022U, 466772998U, 3585256906U, 2063475386U, 1576454197U, 2364330483U, 3210727045U, 1610857396U, 1591733467U, 3054443893U, 3975958631U, 3914153193U, 3279438792U, 4182205326U, 3259743513U, 1405781691U, 2551624412U, 2998886673U, 2616817915U, 1710816442U, 1201195589U, 996291155U, 1592870719U, 2936228599U, 941404459U, 2051992186U, 3388692235U, 4076117933U, 2310610732U, 2851794093U, 2775714195U, 3155386558U, 2274215862U, 3233488783U, 445210568U, 4209824629U, 1288934684U, 3658570496U, 329417919U,
        3982596076U, 3713587677U, 2109195305U, 781307228U, 3555738337U, 1573082816U, 1388676284U, 3105981737U, 3265957520U, 4254854297U, 4032349277U, 1521338546U, 3353148220U, 2405226617U, 249052454U, 1209235358U, 873155164U, 1807979502U, 232605166U, 876279434U, 519643159U, 521599417U, 1875085476U, 348665793U, 1260079566U, 2498553685U, 2426787326U, 4208282136U, 2240524628U, 2472410780U, 262800389U, 1650279593U, 2032271353U, 2620241546U, 1919929691U, 2423730230U, 155048505U, 3267271475U, 1418718119U, 3681407030U, 1681032098U, 3990170633U, 1441905581U, 4152498328U, 1438362084U, 2184746519U, 2671211784U, 3922299058U, 2139138198U, 2015122517U,
        1251621607U, 2628277378U, 857856069U, 1325023743U, 201259261U, 3116540569U, 1225530352U, 3159490783U, 1893441020U, 471645085U, 3574074302U, 1755301983U, 3956694245U, 1435745934U, 1580054332U, 1573122531U, 3488506365U, 1903139082U, 1295730220U, 405522071U, 414001770U, 1223325610U, 2822290256U, 1910426420U, 303598276U, 3243091248U, 3647961596U, 1530763897U, 3493866295U, 2665210212U, 2317976863U, 2590575443U, 2646004184U, 3294918374U, 461797182U, 1016019804U, 4207585587U, 1188000216U, 2629045638U, 1021377278U, 1879504417U, 659963020U, 1665192233U, 1889070774U, 4279705378U, 3383685877U, 2663744255U, 2817594563U, 1132428056U, 3285906385U,
        3030095311U, 422039767U, 2774103498U, 3033235936U, 570044963U, 1870628041U, 1020685539U, 2131980939U, 3837660271U, 3667178650U, 1300243292U, 1510324913U, 4026194289U, 4134784508U, 1793506974U, 4083502527U, 2914339121U, 286731813U, 81396640U, 794038312U, 4192717265U, 3224503268U, 656616238U, 3644696882U, 20314978U, 2508300728U, 1070029425U, 4263782821U, 3390588559U, 3072901966U, 2058140431U, 3684846746U, 641014642U, 1455544336U, 194140620U, 1734318996U, 269361378U, 593096004U, 1062207983U, 2904730727U, 800264950U, 4085654316U, 2802387626U, 3890028136U, 3362866520U, 4232778249U, 1821080085U, 1038606344U, 60271949U, 3484456583U,
        1054083131U, 1605096559U, 3933974415U, 2425499750U, 3360595359U, 950054072U, 2900008645U, 2091525553U, 2233208991U, 960599329U, 2945810742U, 3230453686U, 1554567580U, 3725769253U, 3255552307U, 2644578854U, 306015851U, 994104687U, 3168116228U, 2885849240U, 681277693U, 1140925197U, 1971864057U, 3084370198U, 3053380387U, 1459832645U, 3091891221U, 3870781013U, 2093256753U, 2617677108U, 4042049171U, 4053625110U, 1273607312U, 550295677U, 941052058U, 3347790092U, 517966902U, 1840593306U, 999337844U, 2854637330U, 2329723807U, 2199073857U, 2942335936U, 228173788U, 4286052383U, 2531254624U, 3617546239U, 1277344962U, 235787846U, 1460339190U,
        2099640268U, 4096949051U, 1516476275U, 829736022U, 2793242187U, 404153899U, 828560470U, 1979305550U, 857714316U, 4122790814U, 3384695892U, 2984640439U, 2676539854U, 2101257186U, 782247414U, 3946422902U, 1927329682U, 2649430633U, 4224823714U, 1496399857U, 2335550493U, 1847755177U, 1452806583U
    },
    ._index = 0
};

mt_state_64_t *mt_64_non_sse = &(mt_state_64_t){
    ._states = {
        5489LLU, 13057201162865595358LLU, 10476979627314799022LLU, 15076282145854160703LLU, 4028258760921719184LLU, 16400131027729929813LLU, 681049467949274916LLU, 1166424544479915355LLU, 12669671669325274631LLU, 3923681680445358570LLU, 10843524099671305260LLU, 9320087349666649633LLU, 18036750184230437171LLU, 15162073532206564733LLU, 6406996757156837684LLU, 8927855092125653344LLU, 7287101680298317085LLU, 14285962336228661757LLU, 16767098162355983288LLU, 3083970833968823538LLU, 16292429955202811038LLU, 2462140788281684654LLU, 14987206012938009260LLU, 1755961132248244698LLU, 11853308388629125482LLU, 15567715879394119521LLU, 12922380697022943828LLU, 10568493380422968121LLU, 6468114481096881787LLU, 6912714088192792975LLU, 11676810063224680468LLU, 7989628851951361533LLU, 9980521080467753324LLU, 11628798235400288887LLU, 3042835494701912499LLU, 10149139922063010202LLU, 258211445411067868LLU, 12292608484108957137LLU, 5167437948048335677LLU, 11526653342107776435LLU, 9186605994989076293LLU, 4106436007230823197LLU, 1482400223179564867LLU, 18329651462931014642LLU, 12828698185960104073LLU, 9435381729478913436LLU, 10988179007923054324LLU, 16279301207772373869LLU, 213769070704315526LLU, 2960748844084063679LLU, 10067976150718286789LLU, 9138367034755369774LLU, 13806268603918059639LLU, 1680185388186896326LLU, 10291061633078204420LLU, 14465151537550734149LLU, 15488623881140223366LLU, 3741484074564668314LLU, 1918677755306815564LLU, 7317293401479426455LLU, 4481774452245242266LLU, 13177439052661313103LLU, 14190197572724422343LLU, 11391962132027874483LLU, 14461854875984255581LLU, 78864998355633351LLU, 13375647221931413565LLU, 13091373515385904214LLU, 6049165922138400520LLU, 11416142809731847130LLU, 18197073924412990782LLU, 829354708239552256LLU, 7594476051345711944LLU, 10772269459197422366LLU, 9316238444709656630LLU, 820820292010192239LLU, 10370107716384591311LLU, 8321593491012460630LLU, 9226632414975219865LLU, 1121855342335555726LLU, 2523212579397444422LLU, 15150453816516406687LLU, 4357348246254069950LLU, 1475811360713763769LLU, 14612290868631353049LLU, 13002835200640305831LLU, 8841644283678816855LLU, 9422668006636366709LLU, 9762262470164229443LLU, 15759907042128835526LLU, 5472764997485778171LLU, 7662827925729932877LLU, 17501417670658457528LLU, 3930325588003666236LLU, 5474808447603626986LLU, 6720003803709822382LLU, 1855653125818638627LLU, 17923060195536629896LLU, 1006421872699162065LLU, 8593337867538992416LLU, 4799988366622961201LLU, 13724225912419217109LLU, 11153468036382729521LLU, 3227521569234212702LLU, 14253271084513918446LLU, 12720552637491820050LLU, 3131078640163418426LLU, 13204035025191316893LLU, 1242013424098797151LLU, 10309732291143311392LLU, 14812467554029601896LLU, 6588807180369779774LLU, 15873501535677970563LLU, 11172284785033359089LLU, 12301618027847470633LLU, 11068608208873034498LLU, 11428326129399486324LLU, 5094087545013561907LLU, 500288200114796864LLU, 2634392864069587127LLU, 10024792545775434147LLU, 10356221529759776966LLU, 11136380342514802414LLU, 340782545860183031LLU, 7508198866667469799LLU, 7289875136835936747LLU, 17690097813874199712LLU, 2626238110689777190LLU, 16717695660713672494LLU, 3595834123325255274LLU, 6135238878624366372LLU, 9938504311934907652LLU, 11347072173565906066LLU, 9372835856550536661LLU, 2901728271276724305LLU, 9858149244111900100LLU, 16544617798517122646LLU, 11622889926249457786LLU, 9979924837559772578LLU, 14196945190861012395LLU, 2223272152803307284LLU, 5190516807419032337LLU, 3235768569839659614LLU, 7682633656132343061LLU, 13733309948923027732LLU, 16911272487285603183LLU, 16702635121049437838LLU, 6161415984776321628LLU, 12717629078983493101LLU, 2358424909955325080LLU, 12297813174132617038LLU, 9911119942162973939LLU, 14656296979938373109LLU, 5179190586448371415LLU, 11090893096306857528LLU, 11656051587341971149LLU, 2619718836853156863LLU, 167424595420134768LLU, 1643007456521706830LLU, 4530990928200931669LLU, 4691242637059006353LLU, 3245172607167855857LLU, 3826074447196161535LLU, 3017613396914933622LLU, 17340905364626031202LLU, 7485046344904985266LLU, 4965505580881047325LLU, 7607870693563722899LLU, 7474217805999604818LLU, 9839820025668071488LLU, 3904404505428916804LLU, 9096143925090925215LLU, 11720022622728597618LLU, 14607455239072224349LLU, 9652489256075507508LLU, 16157915074085584685LLU, 8844691517984910790LLU, 4655454640787506604LLU, 13027405036051698459LLU, 7614616053181367064LLU, 7581798355918172953LLU, 15422484141350085613LLU, 7273144328931681164LLU, 4809879802957181824LLU, 8173340538785729893LLU, 8978995124845705037LLU, 1098023286586191126LLU, 3673056527006128025LLU, 10771848665549917601LLU, 2556126669642826596LLU, 5853974322212222290LLU, 4132488280061906262LLU, 7632389934273528542LLU, 9864709072803865332LLU, 1026796482661462016LLU, 1419617114693595331LLU, 3962155586201817099LLU, 667987996344895412LLU, 8873514502505981802LLU, 651162605589119894LLU, 17797581581324995622LLU, 15976116878184660554LLU, 612180284401625759LLU, 5667627227252711358LLU, 10804568037840393823LLU, 13480141817918853670LLU, 1066512862997122338LLU, 3604813770717933001LLU, 13585907467660805157LLU, 205740876326491308LLU, 5991394416108877582LLU, 14926153760506158966LLU, 1763245647862174565LLU, 7472896455769818262LLU, 1880205322011031649LLU, 4964758817614792932LLU, 9867509509583481881LLU, 10312058868395878040LLU, 17252972030239322092LLU, 2606539039210012382LLU, 12769631308639825890LLU, 13775140203463199549LLU, 11099918903372708849LLU, 13347825623771273110LLU, 10911113188423225828LLU, 3460604650247618639LLU, 18367317190899220421LLU, 8882227645936398513LLU, 17724301884678217684LLU, 5689627886741111472LLU, 9758983823681554691LLU, 4544309240290776340LLU, 11463612010490044780LLU, 1863376090611217215LLU, 15532585436324660221LLU, 2614370430655215249LLU, 8917872921271699305LLU, 6432650944098428469LLU, 2156285533792683026LLU, 16620843026246231577LLU, 7840248012245686658LLU, 8817762536320809464LLU, 11411624210052135095LLU, 14469479953922933700LLU, 7687504684721677295LLU, 3569379597009150923LLU, 16298388750432321701LLU, 3546604078275180581LLU, 14090163417090112121LLU, 1483598196549275243LLU, 842296961800625865LLU, 3395823622991339856LLU, 2860049050133253132LLU, 15982791582006104857LLU, 2089985782673048208LLU, 16970930680417346639LLU, 5169822013739423324LLU, 10286951961495655002LLU, 2382826956176138874LLU, 16598361065592133237LLU, 17932005381186616770LLU, 16288375750215523058LLU, 10795004077740592227LLU, 8767132529733815572LLU, 56240711443019961LLU, 16559497623279599758LLU, 110008580074802387LLU, 11565107589793869602LLU, 8340806487881443756LLU, 15870344620874033014LLU, 11296081153908292511LLU, 7302467602367798952LLU, 67243528223816645LLU, 3486356707203513778LLU, 12062986918467299164LLU, 819578200798056089LLU, 18327439140423416057LLU, 14368763774382050055LLU, 15153510095141989578LLU, 3341425261026301804LLU, 773058210352526100LLU, 8392504547028739997LLU, 16740785353247611782LLU, 3373348860032225916LLU, 2701382140093875432LLU, 6671463639189304805LLU, 2761278783662691890LLU, 4685122996515124713LLU, 2654082339795866344LLU, 11329882967399066601LLU, 15952333297690283633LLU, 1697237544920553773LLU, 12370315011795239181LLU, 12798146676828103112LLU, 6070340910131537832LLU, 1447608530827808988LLU, 10598487560452381652LLU, 9074424128904564679LLU, 10368088978608816376LLU, 14242160977535644445LLU, 10536783946433683314LLU, 9271707826703226845LLU, 16651953013385761889LLU, 17192290660721538153LLU, 3817850688440651218LLU, 12138791431534730523LLU, 15752446791766328727LLU, 13797089951075641399LLU, 3884892512265821573LLU, 13501119693269626006LLU, 6429997517378945850LLU, 14292992949928449942LLU
    },
    ._index = 0
};

mt_state_64_t *mt_64 = &(mt_state_64_t) {
    ._states = {
        5489LLU, 13057201162865595358LLU, 10476979627314799022LLU, 15076282145854160703LLU, 4028258760921719184LLU, 16400131027729929813LLU, 681049467949274916LLU, 1166424544479915355LLU, 12669671669325274631LLU, 3923681680445358570LLU, 10843524099671305260LLU, 9320087349666649633LLU, 18036750184230437171LLU, 15162073532206564733LLU, 6406996757156837684LLU, 8927855092125653344LLU, 7287101680298317085LLU, 14285962336228661757LLU, 16767098162355983288LLU, 3083970833968823538LLU, 16292429955202811038LLU, 2462140788281684654LLU, 14987206012938009260LLU, 1755961132248244698LLU, 11853308388629125482LLU, 15567715879394119521LLU, 12922380697022943828LLU, 10568493380422968121LLU, 6468114481096881787LLU, 6912714088192792975LLU, 11676810063224680468LLU, 7989628851951361533LLU, 9980521080467753324LLU, 11628798235400288887LLU, 3042835494701912499LLU, 10149139922063010202LLU, 258211445411067868LLU, 12292608484108957137LLU, 5167437948048335677LLU, 11526653342107776435LLU, 9186605994989076293LLU, 4106436007230823197LLU, 1482400223179564867LLU, 18329651462931014642LLU, 12828698185960104073LLU, 9435381729478913436LLU, 10988179007923054324LLU, 16279301207772373869LLU, 213769070704315526LLU, 2960748844084063679LLU, 10067976150718286789LLU, 9138367034755369774LLU, 13806268603918059639LLU, 1680185388186896326LLU, 10291061633078204420LLU, 14465151537550734149LLU, 15488623881140223366LLU, 3741484074564668314LLU, 1918677755306815564LLU, 7317293401479426455LLU, 4481774452245242266LLU, 13177439052661313103LLU, 14190197572724422343LLU, 11391962132027874483LLU, 14461854875984255581LLU, 78864998355633351LLU, 13375647221931413565LLU, 13091373515385904214LLU, 6049165922138400520LLU, 11416142809731847130LLU, 18197073924412990782LLU, 829354708239552256LLU, 7594476051345711944LLU, 10772269459197422366LLU, 9316238444709656630LLU, 820820292010192239LLU, 10370107716384591311LLU, 8321593491012460630LLU, 9226632414975219865LLU, 1121855342335555726LLU, 2523212579397444422LLU, 15150453816516406687LLU, 4357348246254069950LLU, 1475811360713763769LLU, 14612290868631353049LLU, 13002835200640305831LLU, 8841644283678816855LLU, 9422668006636366709LLU, 9762262470164229443LLU, 15759907042128835526LLU, 5472764997485778171LLU, 7662827925729932877LLU, 17501417670658457528LLU, 3930325588003666236LLU, 5474808447603626986LLU, 6720003803709822382LLU, 1855653125818638627LLU, 17923060195536629896LLU, 1006421872699162065LLU, 8593337867538992416LLU, 4799988366622961201LLU, 13724225912419217109LLU, 11153468036382729521LLU, 3227521569234212702LLU, 14253271084513918446LLU, 12720552637491820050LLU, 3131078640163418426LLU, 13204035025191316893LLU, 1242013424098797151LLU, 10309732291143311392LLU, 14812467554029601896LLU, 6588807180369779774LLU, 15873501535677970563LLU, 11172284785033359089LLU, 12301618027847470633LLU, 11068608208873034498LLU, 11428326129399486324LLU, 5094087545013561907LLU, 500288200114796864LLU, 2634392864069587127LLU, 10024792545775434147LLU, 10356221529759776966LLU, 11136380342514802414LLU, 340782545860183031LLU, 7508198866667469799LLU, 7289875136835936747LLU, 17690097813874199712LLU, 2626238110689777190LLU, 16717695660713672494LLU, 3595834123325255274LLU, 6135238878624366372LLU, 9938504311934907652LLU, 11347072173565906066LLU, 9372835856550536661LLU, 2901728271276724305LLU, 9858149244111900100LLU, 16544617798517122646LLU, 11622889926249457786LLU, 9979924837559772578LLU, 14196945190861012395LLU, 2223272152803307284LLU, 5190516807419032337LLU, 3235768569839659614LLU, 7682633656132343061LLU, 13733309948923027732LLU, 16911272487285603183LLU, 16702635121049437838LLU, 6161415984776321628LLU, 12717629078983493101LLU, 2358424909955325080LLU, 12297813174132617038LLU, 9911119942162973939LLU, 14656296979938373109LLU, 5179190586448371415LLU, 11090893096306857528LLU, 11656051587341971149LLU, 2619718836853156863LLU, 167424595420134768LLU, 1643007456521706830LLU, 4530990928200931669LLU, 4691242637059006353LLU, 3245172607167855857LLU, 3826074447196161535LLU, 3017613396914933622LLU, 17340905364626031202LLU, 7485046344904985266LLU, 4965505580881047325LLU, 7607870693563722899LLU, 7474217805999604818LLU, 9839820025668071488LLU, 3904404505428916804LLU, 9096143925090925215LLU, 11720022622728597618LLU, 14607455239072224349LLU, 9652489256075507508LLU, 16157915074085584685LLU, 8844691517984910790LLU, 4655454640787506604LLU, 13027405036051698459LLU, 7614616053181367064LLU, 7581798355918172953LLU, 15422484141350085613LLU, 7273144328931681164LLU, 4809879802957181824LLU, 8173340538785729893LLU, 8978995124845705037LLU, 1098023286586191126LLU, 3673056527006128025LLU, 10771848665549917601LLU, 2556126669642826596LLU, 5853974322212222290LLU, 4132488280061906262LLU, 7632389934273528542LLU, 9864709072803865332LLU, 1026796482661462016LLU, 1419617114693595331LLU, 3962155586201817099LLU, 667987996344895412LLU, 8873514502505981802LLU, 651162605589119894LLU, 17797581581324995622LLU, 15976116878184660554LLU, 612180284401625759LLU, 5667627227252711358LLU, 10804568037840393823LLU, 13480141817918853670LLU, 1066512862997122338LLU, 3604813770717933001LLU, 13585907467660805157LLU, 205740876326491308LLU, 5991394416108877582LLU, 14926153760506158966LLU, 1763245647862174565LLU, 7472896455769818262LLU, 1880205322011031649LLU, 4964758817614792932LLU, 9867509509583481881LLU, 10312058868395878040LLU, 17252972030239322092LLU, 2606539039210012382LLU, 12769631308639825890LLU, 13775140203463199549LLU, 11099918903372708849LLU, 13347825623771273110LLU, 10911113188423225828LLU, 3460604650247618639LLU, 18367317190899220421LLU, 8882227645936398513LLU, 17724301884678217684LLU, 5689627886741111472LLU, 9758983823681554691LLU, 4544309240290776340LLU, 11463612010490044780LLU, 1863376090611217215LLU, 15532585436324660221LLU, 2614370430655215249LLU, 8917872921271699305LLU, 6432650944098428469LLU, 2156285533792683026LLU, 16620843026246231577LLU, 7840248012245686658LLU, 8817762536320809464LLU, 11411624210052135095LLU, 14469479953922933700LLU, 7687504684721677295LLU, 3569379597009150923LLU, 16298388750432321701LLU, 3546604078275180581LLU, 14090163417090112121LLU, 1483598196549275243LLU, 842296961800625865LLU, 3395823622991339856LLU, 2860049050133253132LLU, 15982791582006104857LLU, 2089985782673048208LLU, 16970930680417346639LLU, 5169822013739423324LLU, 10286951961495655002LLU, 2382826956176138874LLU, 16598361065592133237LLU, 17932005381186616770LLU, 16288375750215523058LLU, 10795004077740592227LLU, 8767132529733815572LLU, 56240711443019961LLU, 16559497623279599758LLU, 110008580074802387LLU, 11565107589793869602LLU, 8340806487881443756LLU, 15870344620874033014LLU, 11296081153908292511LLU, 7302467602367798952LLU, 67243528223816645LLU, 3486356707203513778LLU, 12062986918467299164LLU, 819578200798056089LLU, 18327439140423416057LLU, 14368763774382050055LLU, 15153510095141989578LLU, 3341425261026301804LLU, 773058210352526100LLU, 8392504547028739997LLU, 16740785353247611782LLU, 3373348860032225916LLU, 2701382140093875432LLU, 6671463639189304805LLU, 2761278783662691890LLU, 4685122996515124713LLU, 2654082339795866344LLU, 11329882967399066601LLU, 15952333297690283633LLU, 1697237544920553773LLU, 12370315011795239181LLU, 12798146676828103112LLU, 6070340910131537832LLU, 1447608530827808988LLU, 10598487560452381652LLU, 9074424128904564679LLU, 10368088978608816376LLU, 14242160977535644445LLU, 10536783946433683314LLU, 9271707826703226845LLU, 16651953013385761889LLU, 17192290660721538153LLU, 3817850688440651218LLU, 12138791431534730523LLU, 15752446791766328727LLU, 13797089951075641399LLU, 3884892512265821573LLU, 13501119693269626006LLU, 6429997517378945850LLU, 14292992949928449942LLU
    },
    ._index = 0
};


#define is_odd(value) (value & 1)
//#define mt_vector_cnt(mt) (array_cnt(mt_states(mt)) / vector_cnt(mt_state_entry(mt, 0)))
#define mt_vector_cnt_buffd(mt) ((array_cnt(mt_states(mt)) / vector_cnt(mt_state_entry(mt, 0))))
#define mt_vector_cnt_unbuffd(mt) (mt_vector_cnt_buffd(mt) - 1)

#define mt_lower_mask(mt) ((((mt_state_t(mt))1 << 31) - 1)) // 0x7fffffff
#define mt_upper_mask(mt) (~mt_lower_mask(mt)) // 0x80000000 or 0xFFF80000000

//    int y := (MT[i] & HIGH_BIT) + (MT[(i+1) % 624] & LOW_BITS)
//    MT[i] := (MT[(i + 397) % mt_states_cnt(mt)] ^ (y >> 1)) ^ (((y << 31) >> 31) & (2567483615)) // ^ with 2567483615 if y is odd else do nothing.

//void mt_rand_32_non_vect() { // generate numbers ...
//    word_t index;
//    mt_state_t(mt_32_non_sse) y;
//    for (index = 0; index < mt_states_cnt(mt_32_non_sse); index++) {
//        y = (mt_state_entry(mt_32_non_sse, index)
//            & mt_upper_mask(mt_32_non_sse))
//            + (mt_state_entry(mt_32_non_sse, ((index + 1) % mt_states_cnt(mt_32_non_sse)))
//            & mt_lower_mask(mt_32_non_sse));
//        mt_state_set_entry(
//            mt_32_non_sse,
//            index,
//           (mt_state_entry(mt_32_non_sse, ((index + mt_mid_word(32)) % mt_states_cnt(mt_32_non_sse))) ^ (y >> 1))
//               ^ (mt_coeff(32) & (rshift_airth((y << (bit_size(y) - 1)), (bit_size(y) - 1)))));
//    }
//}

// generate numbers ...
#define mt_rand_non_vect_templ(mt, _bit_mag)                                                \
    void mt_rand_ ## _bit_mag ## _non_vect() {                                              \
        word_t index;                                                                       \
        mt_state_t(mt) y;                                                                   \
        for (index = 0; index < mt_states_cnt(mt); index++) {                               \
            y = (mt_state_entry(mt, index) & mt_upper_mask(mt))                             \
                + (mt_state_entry(mt, ((index + 1) % mt_states_cnt(mt)))                    \
                    & mt_lower_mask(mt));                                                   \
                                                                                            \
            mt_state_set_entry(mt, index,                                                   \
                (mt_state_entry(mt, ((index + mt_mid_word(_bit_mag)) % mt_states_cnt(mt)))  \
                    ^ (y >> 1))                                                             \
                        ^ (mt_coeff(_bit_mag) & (                                           \
                        rshift_airth((y << (bit_size(y) - 1)), (bit_size(y) - 1))           \
                     )));                                                                   \
                                                                                            \
        }                                                                                   \
    }

mt_rand_non_vect_templ(mt_32_non_sse, 32)

mt_rand_non_vect_templ(mt_64_non_sse, 64)

// pre-calculate all the forward indices ...
static const unsigned short mod_indices_32[] = {397, 401, 405, 409, 413, 417, 421, 425, 429, 433, 437, 441, 445, 449, 453, 457, 461, 465, 469, 473, 477, 481, 485, 489, 493, 497, 501, 505, 509, 513, 517, 521, 525, 529, 533, 537, 541, 545, 549, 553, 557, 561, 565, 569, 573, 577, 581, 585, 589, 593, 597, 601, 605, 609, 613, 617, 621, 1, 5, 9, 13, 17, 21, 25, 29, 33, 37, 41, 45, 49, 53, 57, 61, 65, 69, 73, 77, 81, 85, 89, 93, 97, 101, 105, 109, 113, 117, 121, 125, 129, 133, 137, 141, 145, 149, 153, 157, 161, 165, 169, 173, 177, 181, 185, 189, 193, 197, 201, 205, 209, 213, 217, 221, 225, 229, 233, 237, 241, 245, 249, 253, 257, 261, 265, 269, 273, 277, 281, 285, 289, 293, 297, 301, 305, 309, 313, 317, 321, 325, 329, 333, 337, 341, 345, 349, 353, 357, 361, 365, 369, 373, 377, 381, 385, 389, 393};
static const unsigned short mod_indices_64[] = {156, 158, 160, 162, 164, 166, 168, 170, 172, 174, 176, 178, 180, 182, 184, 186, 188, 190, 192, 194, 196, 198, 200, 202, 204, 206, 208, 210, 212, 214, 216, 218, 220, 222, 224, 226, 228, 230, 232, 234, 236, 238, 240, 242, 244, 246, 248, 250, 252, 254, 256, 258, 260, 262, 264, 266, 268, 270, 272, 274, 276, 278, 280, 282, 284, 286, 288, 290, 292, 294, 296, 298, 300, 302, 304, 306, 308, 310, 0, 2, 4, 6, 8, 10, 12, 14, 16, 18, 20, 22, 24, 26, 28, 30, 32, 34, 36, 38, 40, 42, 44, 46, 48, 50, 52, 54, 56, 58, 60, 62, 64, 66, 68, 70, 72, 74, 76, 78, 80, 82, 84, 86, 88, 90, 92, 94, 96, 98, 100, 102, 104, 106, 108, 110, 112, 114, 116, 118, 120, 122, 124, 126, 128, 130, 132, 134, 136, 138, 140, 142, 144, 146, 148, 150, 152, 154};
#define mod_indices(bit_mag) mod_indices_ ## bit_mag

#define mt_vector_cnt(type) (sizeof(vector_t) / sizeof(type))
#define mt_state_vector_cnt(mt) (mt_state_word_cnt(mt_state_t(mt)) / mt_vector_cnt(mt_state_t(mt)))

#define mt_rand_vect_tmpl(mt, bit_mag)                                                                \
    void mt_rand_ ## bit_mag ## _init_vect() {                                                        \
        vector_t                                                                                      \
            *entries = (void *)&(mt_state_entry(mt, 0)),                                              \
            *forward = (void *)&(mt_state_entry(mt, 1));                                              \
        const vector_t                                                                                \
            high_bit_mask   = vector_broad_cast_i(mt_upper_mask(mt)),                                 \
            low_bits_mask   = vector_broad_cast_i(mt_lower_mask(mt)),                                 \
            odd_mask        = vector_broad_cast_i(mt_coeff(bit_mag));                                 \
        /* do the first vector ... */                                                                 \
        vector_t y = vector_add_i(                                                                    \
            vector_and(vector_load_align(entries), high_bit_mask),                                    \
            vector_and(vector_load(forward), low_bits_mask),                                          \
            mt_state_t(mt)                                                                            \
        );                                                                                            \
        vector_t temp;                                                                                \
        vector_store_algin(                                                                           \
            entries,                                                                                  \
            (temp = vector_xor(                                                                       \
                vector_xor(                                                                           \
                    vector_load((void *)&mt_state_entry(mt, mt_mid_word(bit_mag))),                   \
                    vector_bits_logc_rshft_imm(y, (mt_state_t(mt))1)                                  \
                ),                                                                                    \
                vector_and(                                                                           \
                    vector_bits_arith_rshft_imm(                                                      \
                        vector_bits_lshft_imm(y, (mt_state_t(mt))(bit_size(mt_state_t(mt)) - 1)),     \
                        (mt_state_t(mt))(bit_size(mt_state_t(mt)) - 1)                                \
                    ),                                                                                \
                    odd_mask                                                                          \
                )                                                                                     \
            ))                                                                                        \
        );                                                                                            \
        vector_store_algin((void *)&mt_state_entry(mt, mt_states_cnt(mt)), temp);                     \
                                                                                                      \
        word_t index;                                                                                 \
        for (index = 1; index < mt_state_vector_cnt(mt); index++) {                                   \
            vector_t y = vector_add_i(                                                                \
                vector_and(vector_load_align(&entries[index]), high_bit_mask),                        \
                vector_and(vector_load(&forward[index]), low_bits_mask),                              \
                mt_state_t(mt)                                                                        \
            );                                                                                        \
                                                                                                      \
            vector_store_algin(                                                                       \
                &entries[index],                                                                      \
                vector_xor(                                                                           \
                    vector_xor(                                                                       \
                        vector_load((void *)&mt_state_entry(mt, mod_indices(bit_mag)[index])),        \
                        vector_bits_logc_rshft_imm(y, (mt_state_t(mt)) 1)                             \
                    ),                                                                                \
                    vector_and(                                                                       \
                        vector_bits_arith_rshft_imm(                                                  \
                            vector_bits_lshft_imm(y, (mt_state_t(mt))(bit_size(mt_state_t(mt)) - 1)), \
                            (mt_state_t(mt))(bit_size(mt_state_t(mt)) - 1)                            \
                        ),                                                                            \
                        odd_mask                                                                      \
                    )                                                                                 \
                )                                                                                     \
            );                                                                                        \
        }                                                                                             \
    }

mt_rand_vect_tmpl(mt_32, 32)

mt_rand_vect_tmpl(mt_64, 64)

//void mt_rand_32_vect() {
//    vector_t
//        *entries = (void *)&(mt_state_entry(mt_32, 0)),
//        *forward = (void *)&(mt_state_entry(mt_32, 1));
//
//
//    const vector_t
//        high_bit_mask = vector_broad_cast_i(mt_upper_mask(mt_32)),
//        low_bits_mask = vector_broad_cast_i(mt_lower_mask(mt_32)),
//        odd_mask = vector_broad_cast_i(mt_coeff(32));
//
//    // do the first vector ...
//    vector_t y = vector_add_i(
//        vector_and(vector_load_align(entries), high_bit_mask),
//        vector_and(vector_load(forward), low_bits_mask),
//        mt_state_t(mt_32)
//    );
//
//    vector_t temp;
//    vector_store_algin(
//        entries,
//        (temp = vector_xor(
//            vector_xor(
//                vector_load((void *)&mt_state_entry(mt_32, mt_mid_word(32))),
//                vector_bits_logc_rshft_imm(y, (mt_state_t(mt_32))1)
//            ),
//            vector_and(
//                vector_bits_arith_rshft_imm(
//                    vector_bits_lshft_imm(y, (mt_state_t(mt_32))(bit_size(mt_state_t(mt_32)) - 1)), //  ((signed)(y << 31) >> 31)
//                    (mt_state_t(mt_32))(mt_state_t(mt_32))(bit_size(mt_state_t(mt_32)) - 1)
//                ),
//                odd_mask
//            )
//        ))
//    );
//    vector_store_algin((void *)&mt_state_entry(mt_32, mt_states_cnt(mt_32)), temp); // copy first vector beyong state table so as not to segfault and correct values are used.
//
//    // pre-calculate all the mod indices ...
//    static const unsigned short mod_indices[] = {397, 401, 405, 409, 413, 417, 421, 425, 429, 433, 437, 441, 445, 449, 453, 457, 461, 465, 469, 473, 477, 481, 485, 489, 493, 497, 501, 505, 509, 513, 517, 521, 525, 529, 533, 537, 541, 545, 549, 553, 557, 561, 565, 569, 573, 577, 581, 585, 589, 593, 597, 601, 605, 609, 613, 617, 621, 1, 5, 9, 13, 17, 21, 25, 29, 33, 37, 41, 45, 49, 53, 57, 61, 65, 69, 73, 77, 81, 85, 89, 93, 97, 101, 105, 109, 113, 117, 121, 125, 129, 133, 137, 141, 145, 149, 153, 157, 161, 165, 169, 173, 177, 181, 185, 189, 193, 197, 201, 205, 209, 213, 217, 221, 225, 229, 233, 237, 241, 245, 249, 253, 257, 261, 265, 269, 273, 277, 281, 285, 289, 293, 297, 301, 305, 309, 313, 317, 321, 325, 329, 333, 337, 341, 345, 349, 353, 357, 361, 365, 369, 373, 377, 381, 385, 389, 393};
//    word_t index;
//    for (index = 1; index < mt_vector_cnt_buffd(mt_32); index++) {
//        vector_t y = vector_add_i(
//            vector_and(vector_load_align(&entries[index]), high_bit_mask),
//            vector_and(vector_load(&forward[index]), low_bits_mask),
//            mt_state_t(mt_32)
//        );
//
//        vector_store_algin(
//            &entries[index],
//            vector_xor(
//                vector_xor(
//                    vector_load((void *)&mt_state_entry(mt_32, mod_indices[index])), //((index * (vector_cnt(mt_state_t(mt_32)))) + 397) % RAND_GEN_STATE_LENGTH)),
//                    vector_bits_logc_rshft_imm(y, (mt_state_t(mt_32)) 1)
//                ),
//                vector_and(
//                    vector_bits_arith_rshft_imm(
//                        vector_bits_lshft_imm(y, (mt_state_t(mt_32))(bit_size(mt_state_t(mt_32)) - 1)), //  ((signed)(y << 31) >> 31)
//                        (mt_state_t(mt_32))(mt_state_t(mt_32))(bit_size(mt_state_t(mt_32)) - 1)
//                    ),
//                    odd_mask
//                )
//            )
//        );
//    }
//}


#define mt_srand_non_sse_templ(mt, bit_mag)                                     \
    void mt_srand_ ## bit_mag ## _non_sse(mt_state_t(mt) seed) {                \
        mt_set_index(mt, 0);                                                    \
        mt_state_set_entry(mt, 0, seed);                                        \
        unsigned word_t index;                                                  \
        for (index = 1; index < mt_states_cnt(mt); index++)                     \
            mt_state_set_entry(                                                 \
                mt,                                                             \
                index,                                                          \
                (mt_seed_coef(bit_mag) * (mt_state_entry(mt, index - 1)         \
                     ^ (mt_state_entry(mt, index - 1)                           \
                         >> (bit_size(mt_state_t(mt)) - 2))) + index)           \
            );                                                                  \
    }


mt_srand_non_sse_templ(mt_32_non_sse, 32)
mt_srand_non_sse_templ(mt_64_non_sse, 64)

//void mt_rand_32_srand_non_sse(unsigned seed) {
//    mt_set_index(mt_32_non_sse, 0);
//    mt_state_set_entry(mt_32_non_sse, 0, seed);
//
//    unsigned index;
//    for (index = 1; index < mt_states_cnt(mt_32_non_sse); index++)
//        mt_state_set_entry(
//            mt_32_non_sse,
//            index,
//            (mt_seed_coef(32) *
//                (mt_state_entry(mt_32_non_sse, index - 1)
//                    ^ (mt_state_entry(mt_32_non_sse, index - 1)
//                        >> (bit_size(mt_state_t(mt_32_non_sse)) - 2))) + index)
//        );
//}

void mt_rand_32_srand(unsigned seed) {
    mt_set_index(mt_32, 0);
    mt_state_set_entry(mt_32, 0, seed);

    vector_t *entries = (vector_t *)mt_states(mt_32), prev_vect;
    const vector_t factor = vector_broad_cast_i(mt_seed_coef(32));

    unsigned index;
    for (index = 1; index < vector_cnt(mt_state_t(mt_32)); index++) // set the first vector ...
        mt_state_set_entry(
            mt_32,
            index,
            (mt_seed_coef(32)
                * (mt_state_entry(mt_32, index - 1)
                    ^  (mt_state_entry(mt_32, index - 1)
                        >> (bit_size(mt_state_t(mt_32)) - 2))) + index)
        );

    prev_vect = vector_load(entries);
    for (index = 1; index < mt_state_vector_cnt(mt_32); index++)
        vector_store(
            &entries[index],
            prev_vect = vector_add_i(
                vector_mul_i(
                    factor,
                    vector_xor(
                        prev_vect,
                        vector_bits_lshft_imm(prev_vect, (mt_state_t(mt_32))(bit_size(mt_state_t(mt_32)) - 2))
                    ),
                    mt_state_t(mt_32)
                ),
                vector_broad_cast_i(index),
                mt_state_t(mt_32)
            )
        );
}




#define mt_tamper_32(y) ({              \
    y ^=  (y >> 11);                    \
    y ^= ((y << 7) & 2636928640U);      \
    y ^= ((y << 15) & 4022730752U);     \
    y ^=  (y >> 18);                    \
y; })

#define mt_tamper_64(y) ({                      \
    y ^= (y >> 29) & 0x5555555555555555ULL;     \
    y ^= (y << 17) & 0x71D67FFFEDA60000ULL;     \
    y ^= (y << 37) & 0xFFF7EEE000000000ULL;     \
    y ^= (y >> 43);                             \
y; })

#define mt_tamper(bit_mag) mt_tamper_ ## bit_mag


//unsigned int mt_rand_32_non_sse() {
//    if (!mt_index(mt_32_non_sse))
//        mt_rand_32_non_vect();
//
//    typeof(mt_state_t(mt_32_non_sse)) y = mt_state_entry(mt_32_non_sse, mt_index(mt_32_non_sse));
//    mt_set_index(mt_32_non_sse, (mt_index(mt_32_non_sse) + 1) % mt_states_cnt(mt_32_non_sse));
//
//    y ^=  (y >> 11);
//    y ^= ((y << 7) & 2636928640U);
//    y ^= ((y << 15) & 4022730752U);
//    y ^=  (y >> 18);
//
//    return y;
//}

#define mt_rand_non_sse_templ(mt, bit_mag)                           \
    typeof(mt_state_t(mt)) mt_rand_ ## bit_mag ## _non_sse() {       \
        if (!mt_index(mt))                                           \
            mt_rand_ ## bit_mag ## _non_vect();                      \
        typeof(mt_state_t(mt)) y = mt_state_entry(mt, mt_index(mt)); \
        mt_set_index(mt, (mt_index(mt) + 1) % mt_states_cnt(mt));    \
        return mt_tamper(bit_mag)(y);                                \
    }

mt_rand_non_sse_templ(mt_32_non_sse, 32)
mt_rand_non_sse_templ(mt_64_non_sse, 64)


mt_state_t(mt_32) mt_rand_32() {
    static vector_t vect_align_attr(vector_t) y[mt_state_vector_cnt(mt_32)];

    static word_t y_index = mt_states_cnt(mt_32);

    if (__builtin_expect(y_index < mt_states_cnt(mt_32), 1))
        return ((mt_state_t(mt_32) *)y)[y_index++];

    mt_rand_32_init_vect();

    const vector_t
        mask_0 = vector_broad_cast_i(2636928640U),
        mask_1 = vector_broad_cast_i(4022730752U);

    vector_t *entries = (void *)mt_states(mt_32);
    for (y_index = 0; y_index < (sizeof(y)/sizeof(y[0])); y_index++) {
        vector_t temp = vector_load_align(&entries[y_index]);

        temp = vector_xor(temp, vector_bits_logc_rshft_imm(temp, (mt_state_t(mt_32))11));
        temp = vector_xor(temp, vector_and(mask_0, vector_bits_lshft_imm(temp, (mt_state_t(mt_32))7)));
        temp = vector_xor(temp, vector_and(mask_1, vector_bits_lshft_imm(temp, (mt_state_t(mt_32))15)));
        temp = vector_xor(temp, vector_bits_logc_rshft_imm(temp, (mt_state_t(mt_32))18));

        vector_store_algin(&y[y_index], temp);
    }

    y_index = 1;
    return *((mt_state_t(mt_32) *)y);
}

mt_state_t(mt_64) mt_rand_64() {
    static vector_t vect_align_attr(vector_t) y[mt_state_vector_cnt(mt_64)];

    static word_t y_index = mt_states_cnt(mt_64);

    if (__builtin_expect(y_index < mt_states_cnt(mt_64), 1))
        return ((mt_state_t(mt_64) *)y)[y_index++];

    mt_rand_64_init_vect();

    const vector_t
        mask_0 = vector_broad_cast_i(0x5555555555555555ULL),
        mask_1 = vector_broad_cast_i(0x71D67FFFEDA60000ULL),
        mask_2 = vector_broad_cast_i(0xFFF7EEE000000000ULL);

    vector_t *entries = (void *)mt_states(mt_64);
    for (y_index = 0; y_index < (sizeof(y)/sizeof(y[0])); y_index++) {
        vector_t temp = vector_load_align(&entries[y_index]);

        temp = vector_xor(temp, vector_and(vector_bits_logc_rshft_imm(temp, (mt_state_t(mt_64))29), mask_0));
        temp = vector_xor(temp, vector_and(vector_bits_lshft_imm(temp, (mt_state_t(mt_64))17), mask_1));
        temp = vector_xor(temp, vector_and(vector_bits_lshft_imm(temp, (mt_state_t(mt_64))37), mask_2));
        temp = vector_xor(temp, vector_bits_logc_rshft_imm(temp, (mt_state_t(mt_64))43));

        vector_store_algin(&y[y_index], temp);
    }

    y_index = 1;
    return *((mt_state_t(mt_64) *)y);
}



double qual_of_distr(unsigned (*rand_func)(), unsigned max_symb) {// meassure the quality of the distribution
    word_t counts[max_symb], index;
    memset(counts, 0, max_symb * sizeof(counts[0]));
    #define DISTR_TEST_SIZE 100000000

    // a good number generator will generate each value with equal probability, the close var(counts) is zero the better ...
    for (index = 0; index < DISTR_TEST_SIZE; index++)
        counts[rand_func() % max_symb]++;

    double sum = 0;
    for (index = 0; index < max_symb; index++) {
//        printf("%llu\n", counts[index]);
        sum += (double)counts[index];
    }
    double mean = sum/max_symb;
    printf("sum: %f mean: %f max: %llu\n", sum, mean, max_symb);

    word_t j;
    double var = 0;
    for (index = 0; index < max_symb; index++)
        var += ((double)counts[index] - mean)/((double)max_symb);

    return var;
}

void test_mt_rand() {
    #define TEST_MT_RAND_TEST_SIZE 500000000
    unsigned index;

    mt_state_t(mt_32_non_sse) sse_r, non_sse_r;
    mt_state_t(mt_64_non_sse) sse_r_64, non_sse_r_64;

    sse_r = mt_rand_32();
    non_sse_r = mt_rand_32_non_sse();
    for (index = 0; index < mt_states_cnt(mt_32); index++)
        if (mt_state_entry(mt_32, index) != mt_state_entry(mt_32_non_sse, index))
            printf(
                "bad 32 bit state index: %u exp: %u got: %u\n",
                index, mt_state_entry(mt_32_non_sse, index), mt_state_entry(mt_32, index)
            ), exit(-2);

    sse_r_64 = mt_rand_64();
    non_sse_r_64  = mt_rand_64_non_sse();
    for (index = 0; index < mt_states_cnt(mt_64); index++)
        if (mt_state_entry(mt_64, index) != mt_state_entry(mt_64_non_sse, index))
            printf(
                "bad 64 bit state index: %u exp: %llu got: %llu\n",
                index, mt_state_entry(mt_64_non_sse, index), mt_state_entry(mt_64, index)
            ), exit(-2);

    for (index = 0 ; index < TEST_MT_RAND_TEST_SIZE; index++)
        if ((sse_r = mt_rand_32()) != (non_sse_r = mt_rand_32_non_sse())) {
            printf("mt_rand_32 index: %u non_sse_exp: %u sse_got %u\n", index, non_sse_r, sse_r);
            printf("mt_sse_index: %u mt_non_sse_index: %u\n", mt_index(mt_32), mt_index(mt_32_non_sse));
            exit(-1);
        }

    for (index = 0 ; index < TEST_MT_RAND_TEST_SIZE; index++)
        if ((sse_r_64 = mt_rand_64()) != (non_sse_r_64 = mt_rand_64_non_sse())) {
            printf("mt_rand_64: index: %u non_sse_exp: %llu sse_got %llu\n", index, non_sse_r_64, sse_r_64);
            printf("mt_sse_index: %llu mt_non_sse_index: %llu\n", mt_index(mt_64), mt_index(mt_64_non_sse));
            exit(-1);
        }

    #define test_sys_rand() ({for (index = 0; index < TEST_MT_RAND_TEST_SIZE; index++) rand();})

    #define test_get_rand() ({for (index = 0 ; index < TEST_MT_RAND_TEST_SIZE; index++) mt_rand_32();})
    #define test_get_rand_64() ({for (index = 0 ; index < TEST_MT_RAND_TEST_SIZE; index++) mt_rand_64();})

    #define test_get_rand_non_sse() ({for (index = 0 ; index < TEST_MT_RAND_TEST_SIZE; index++) mt_rand_32_non_sse();})
    #define test_get_rand_non_sse_64() ({for (index = 0 ; index < TEST_MT_RAND_TEST_SIZE; index++) mt_rand_64_non_sse();})

    double sys_rand_time = timed(test_sys_rand);

    double rand_32_gen_time = timed(test_get_rand);
    double rand_32_non_sse_gen_time = timed(test_get_rand_non_sse);

    double rand_64_gen_time = timed(test_get_rand_64);
    double rand_64_non_sse_gen_time = timed(test_get_rand_non_sse_64);


    printf("sys_rand_time: %.4fs rate: %.4f/s \n",
        sys_rand_time, TEST_MT_RAND_TEST_SIZE/sys_rand_time);
    printf("test_mt_rand_32_non_sse: %.4fs rate: %.4f/s\n",
        rand_32_non_sse_gen_time, TEST_MT_RAND_TEST_SIZE/rand_32_non_sse_gen_time);
   printf("test_mt_rand_sse: %.4fs rate: %.4f/s bit_rate: %.4f/s\n",
       rand_32_gen_time,
       TEST_MT_RAND_TEST_SIZE/rand_32_gen_time,
       (TEST_MT_RAND_TEST_SIZE/rand_32_gen_time) * bit_size(mt_state_t(mt_32)));

    printf("sse speed up: %.3f%%\n\n", ((rand_32_non_sse_gen_time - rand_32_gen_time)/rand_32_gen_time) * 100);

    printf("test_rand_64_non_sse_gen_time: %.4fs rate: %.4f/s\n",
        rand_64_non_sse_gen_time, TEST_MT_RAND_TEST_SIZE/rand_64_non_sse_gen_time);
    printf("test_mt_rand_64_sse: %.4fs rate: %.4f/s bit_rate: %.4f/s\n",
        rand_64_gen_time,
        TEST_MT_RAND_TEST_SIZE/rand_64_gen_time,
        (TEST_MT_RAND_TEST_SIZE/rand_64_gen_time) * bit_size(mt_state_t(mt_64)));
   printf("sse speed up: %.3f%%\n\n", ((rand_64_non_sse_gen_time - rand_64_gen_time)/rand_64_gen_time) * 100);
}

int main() {
    test_mt_rand();

    return 0;
}